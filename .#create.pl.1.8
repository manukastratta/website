#!/usr/bin/perl

$template_dir = "TEMPLATES";
$data_dir = "DATA";
$tmp_dir = "TMP";
open(OUTLINE, "$data_dir/OUTLINE.TXT");

`rm -f TMP/*`;
`cp -f $data_dir/DATA* $tmp_dir`;

@mainmenus;
@submenus;
@mainlink;
@all;
int i;
foreach (<OUTLINE>) {
    s/\n//;
    if (/([\w|\s]*):/) {
	$mainmenu_txt = $1;
	@mainmenus[$i] = $mainmenu_txt;

	$submenus_txt = $_;
	$submenus_txt =~ s/$mainmenu_txt: //;
	@submenus{"$mainmenu_txt"} = $submenus_txt;

	@submenus_arr = split(/\, /,$submenus_txt);
	push(@all, @submenus_arr);
	@mainlink{"$mainmenu_txt"} = @submenus_arr[0];
    }
    else {
	@mainmenus[$i] = $_;

	push(@all, $_);
    }
    $i++;
}
close(OUTLINE);

# Create the performance data files.
opendir(DIR, "$data_dir");
@calendars = grep(/^CAL/, (sort readdir(DIR)));
closedir(DIR);
foreach $c (@calendars) {
    @calendar = "";
    open(DATA, "$data_dir/$c");
    foreach (<DATA>) {
	s/\n//;
	push(@calendar, $_);
    }
    close(DATA);
    
    $file = $c;
    $file =~ s/CAL/DATA/;
    $file =~ s/TXT/HTML/;
    @foreach_array = @calendar;
    create_from_template("$template_dir/CALENDAR_TEMPLATE.HTML",
			 "$tmp_dir/$file", "CALENDAR");
}

# Create the home announcement data file.
open(FILE, "$data_dir/ANNOUNCE.HTML") or die;
$announcement = "";
@announce_arr;
foreach (<FILE>) {
    s/\n/ /;
    if ($_ eq " ") {
	push(@announce_arr, $announcement);
	$announcement = "";
    }
    else {
	$announcement = "$announcement$_";
    }
}
if (!($announcement eq "")) {
    push(@announce_arr, $announcement);
}
close(FILE);
@foreach_array = @announce_arr;
create_from_template("$template_dir/HOME_TEMPLATE.HTML",
		     "$tmp_dir/DATA_Home.HTML", "HOME");
create_from_template("$template_dir/HOME_TEMPLATE.HTML",
		     "$tmp_dir/DATA_Member_Home.HTML", "HOME");


# Create the menu.html file.
@foreach_array = @mainmenus;
create_from_template("$template_dir/MENU_TEMPLATE.HTML",
		     "Menu.html", "MENU");

# Create the sub-menu files.
@images;
@credits;
@imgpages;
@borders;
foreach $m (@mainmenus) {
    $file = $m;
    $file =~ s/ /_/g;
    
    $submenus_txt = @submenus{"$m"};
    @submenus_arr = split(/\, /,$submenus_txt);
    @foreach_array = @submenus_arr;
    create_from_template("$template_dir/SUBMENU_TEMPLATE.HTML",
			 "$file.html", "MENU");

    if ($submenus_txt !~ /\w+/) {
	create_from_template("$template_dir/MAIN_TEMPLATE.HTML",
			     "$file.shtml", "$m");
    }
    else {
	foreach $sm (@submenus_arr) {
	    $file = $sm;
	    $file =~ s/ /_/g;
	    create_from_template("$template_dir/MAIN_TEMPLATE.HTML",
				 "$file.shtml", "$m");
	}
    }
}

# Create the photo credits page
@foreach_array = @images;
create_from_template("$template_dir/CREDITS_TEMPLATE.HTML",
		     "$tmp_dir/DATA_Photo_Credits.HTML", "CREDITS");
create_from_template("$template_dir/MAIN_TEMPLATE.HTML",
		     "Photo_Credits.shtml", "Gallery");

`ln -s Home.shtml index.shtml`;
`ln -s Member_Home.shtml Home.shtml`;



sub create_from_template {
    my $template_filename = $_[0];
    my $html_filename = $_[1];
    my $extra = $_[2];

    my $heading = $html_filename;
#    $heading =~ s/public\///;
    $heading =~ s/.shtml//;
    $heading =~ s/_/ /g;

    if ($extra !~ /MENU/ && $extra !~ /CALENDAR/) {
	$extra =~ s/ /_/g;
	$text = "";
	$datafilename = "$tmp_dir/DATA_$html_filename";
#	$datafilename =~ s/public\//public\/DATA_/;
	$datafilename =~ s/shtml/HTML/;
	$textdata = 0;
	if (open(DATA, "$datafilename") == 1) {
	    print "$datafilename\n";
	}
	else {
	    $textdata = 1;
	    $datafilename =~ s/HTML/TXT/;
	    if (open(DATA, "$datafilename") == 1) {
		print "$datafilename\n";
	    }
	    else {
		print "ERROR: No $datafilename found\n";
	    }
	}
	$topimg = "";
	$border = 1;
	$botimg = "";
	$credit = "";
	$directives = "";
	$align = "";
	foreach (<DATA>) {
	    if (/(\w\w\w)img/) {
		$type = $1;
		$img = $_;
		if ($img =~ /,([\w\s]*)/) {
		    $credit = $1;
		    $img =~ s/,([\w\s]*)//;
		}
		
		if ($img =~ /,(\d)/) {
		    $border = $1;
		    $img =~ s/,\d//;
		}

		if ($img =~ /,(\w*)/) {
		    $img =~ s/,(\w*)//;
		    $align = $1;
		}

		if ($img =~ /,(.*)/) {
		    $img =~ s/,(.*)//;
		    $directives = $1;
		}		
		$img =~ s/\w\w\wimg=//;
		push(@images, $img);
		@credits{"$img"} = $credit;
		@imgpages{"$img"} = $heading;
		@borders{"$img"} = $border;

		if ($type eq "bot") {
		    $botimg = $img;
		}
		elsif ($type eq "top") {
		    $topimg = $img;
		}
	    }
	    elsif ($textdata) {
		if ($text eq "") {
		    $text = $_;
		}
		else {
		    $text = "$text<br>$_";
		}
	    }
	    else {
		$text = "$text$_";
	    }
	}
	close(DATA);
    }

    open(TEMPLATE, "$template_filename");
    open(HTML, ">$html_filename");

    foreach (<TEMPLATE>) {
	if (/\[endforeach\]/) {
	    $foreach_bool = 0;

	    $i = 0;
	    foreach $foreach_item (@foreach_array) {
		$file = @mainlink{"$foreach_item"};
		if ($file !~ /\w+/) {
		    $file = $foreach_item;
		}

		$file =~ s/ /_/g;
		
		$_ = $foreach_str;
		s/\[file\]/$file/g;
		s/\[item\]/$foreach_item/g;

		$itermod2 = $i % 2;
		s/\[itermod2\]/$itermod2/g;		

		if ($extra =~ /CALENDAR/) {
		    @event = split(/ \# /,$foreach_item);
		    $date = @event[0];
		    $date =~ s/, \d\d\d\d//;
		    $title = @event[1];
		    $location = @event[2];
		    $time = @event[3];
		    $call = @event[4];
		    $dress = @event[5];
		    
		    s/\[date\]/$date/g;
		    s/\[ev_title\]/$title/g;
		    s/\[call\]/$call/g;
		    s/\[dress\]/$dress/g;
		    if ($location && $time) {
			s/\[details\]/<br>$location, $time/;
		    }
		    elsif ($location) {
			s/\[details\]/<br>$location/;
		    }
		    elsif ($time) {
			s/\[details\]/$time/;
		    }
		    else {
			s/\[details\]//;
		    }
		}
		elsif ($extra =~ /CREDITS/) {
		    $border = @borders{"$foreach_item"};
		    s/\[imgborder\]/$border/;
		    $credit = @credits{"$foreach_item"};
		    s/\[imgcredit\]/$credit/;
		    $heading = @imgpages{"$foreach_item"};
		    s/\[imgheading\]/$heading/;
		    $link = "$heading.shtml";
		    $link =~ s/ /_/g;
		    s/\[imglink\]/$link/;
		}

		print HTML $_;
		$i++;
	    }

	    $foreach_str = "";
	    $_ = "";
	}
	elsif (/\[submenu\]/) {
	    s/\[submenu\]/$extra/;
	}
	elsif (/img\]/) {
	    if (/\[topimg\]/) {
		if (!($topimg eq "")) {
		    s/\[topimg\]/<img border="$border" $directives align="right" src="$topimg">/;
		}
		else {
		    $_ = "";
		}
	    }
	    elsif (/\[botimg\]/) {		
		if (!($botimg eq "")) {
		    s/\[imgalign\]/$align/;
		    s/\[botimg\]/<img border="$border" $directives src="$botimg">/;
		}
		else {
		    $_ = "";		
		}
	    }
	}	
	elsif (/\[title\]/) {
	    if ($heading !~ /Home/) {
		s/\[title\]/:: Swingtime - $heading ::/;
	    }
	    else {
		s/\[title\]/:: Swingtime Swing Dance Troupe ::/;
	    }
	}
	elsif (/\[heading\]/) {
	    if ($heading !~ /Home/) {
		s/\[heading\]/$heading/;
	    }
	    else {
		$_ = "";
	    }
	}
	elsif (/\[pad\]/) {
	    if ($heading !~ /Home/) { 
		s/\[pad\]/5/;
	    }
	    else {
		s/\[pad\]/5/;		
	    }
	}
	elsif (/\[text\]/) {
	    s/\[text\]/$text/;
	}
	elsif ($foreach_bool) {
	    $foreach_str = "$foreach_str$_";
	    $_ = "";
	}
	elsif (/\[foreach\]/) {
	    $foreach_bool = 1;
	    $_ = "";
	}

	print HTML $_;
    }
    close(HTML);
    close(TEMPLATE);
}
